<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>Demo</title>

    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />

    <!--Add mapbox.js -->
    <script src='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.2/mapbox.css' rel='stylesheet' />

    <!--Add draw plugin -->
    <link rel='stylesheet' href='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.css' />
    <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-draw/v0.2.2/leaflet.draw.js'></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        #delete, #export {
            position: absolute;
            top:50px;
            right:10px;
            z-index:100;
            background:white;
            color:black;
            padding:6px;
            border-radius:4px;
            font-family: 'Helvetica Neue';
            cursor: pointer;
            font-size:12px;
            text-decoration:none;
        }
        #export {
            top:90px;
        }
    </style>
</head>

<body>

    <div id='map'></div>
    <div id='delete'>Delete Features</div>
    <a href='#' id='export'>Export Features</a>

    <script>
        var map = L.map('map')
            .setView([41.893333, 12.482778], 14);

        // Add layers to the map
        L.control.layers({
            'Satellite Map': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
              attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }).addTo(map),
            'Street Map': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            	maxZoom: 19,
            	attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }),
            'Giuseppe Grande': L.tileLayer('https://raw.githubusercontent.com/jebowe3/rome-giuseppe-grande/main/{z}/{x}/{y}.png', {
              tms: true,
              opacity: 0.7,
              attribution: "",
              minZoom: 11,
              maxZoom: 17
            })
        }).addTo(map);

        var featureGroup = L.featureGroup().addTo(map);

        var lineGroup = {
          type: 'FeatureCollection',
          features: []
        };
        var polyGroup = {
          type: 'FeatureCollection',
          features: []
        };
        var pointGroup = {
          type: 'FeatureCollection',
          features: []
        };

        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: featureGroup
            }
        }).addTo(map);

        map.on('draw:created', function(e) {

            var layer = e.layer,
                feature = layer.feature = layer.feature || {};

            feature.type = feature.type || "Feature";

            var props = feature.properties = feature.properties || {};

            props.name = null;
            props.description = null;

            // Each time a feature is created, it is added to the over arching feature group
            featureGroup.addLayer(layer);

            addPopup(layer);
        });

        // on click, clear all layers
        document.getElementById('delete').onclick = function(e) {
            featureGroup.clearLayers();
        }

        document.getElementById('export').onclick = function(e) {

            // Extract GeoJson from featureGroup
            var data = featureGroup.toGeoJSON();

            // Stringify the GeoJson
            var convertedData = 'text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data));

            for (var i = 0; i < data.features.length; i++) {

              var feature = data.features[i];
              var geomType = feature.geometry.type;

              if (geomType == "LineString") {
                //console.log(feature);
                lineGroup.features.push(feature);
              } if (geomType == "Polygon") {
                //console.log(feature);
                polyGroup.features.push(feature);
              } if (geomType == "Point") {
                //console.log(feature);
                pointGroup.features.push(feature);
              }

            };

            downloadObjectAsJson(lineGroup, 'lineData');
            downloadObjectAsJson(polyGroup, 'polyData');
            downloadObjectAsJson(pointGroup, 'pointData');
/*
            var convertedLine = 'text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(lineGroup));
            var convertedPoly = 'text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(polyGroup));
            var convertedPoint = 'text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(pointGroup));

            const geoms = [convertedLine, convertedPoly, convertedPoint];

            for (var i = 0; i < geoms.length; i++) {
              //var download = filesForDownload[i];
              document.getElementById('export').setAttribute('href', 'data:' + geoms[i]);
              document.getElementById('export').setAttribute('download', null);
            }
*/
            // Create export
            //document.getElementById('export').setAttribute('href', 'data:' + convertedData);
/*
            document.getElementById('export').setAttribute('href', 'data:' + convertedLine);
            document.getElementById('export').setAttribute('download','lineData.geojson');

            document.getElementById('export').setAttribute('href', 'data:' + convertedPoly);
            document.getElementById('export').setAttribute('download','polyData.geojson');

            document.getElementById('export').setAttribute('href', 'data:' + convertedPoint);
            document.getElementById('export').setAttribute('download','pointData.geojson');
*/
        }

        function addPopup(layer) {

          // Create an input form
          var formDiv = document.createElement("div");
          var form = formDiv.appendChild(document.createElement('form'));
          form.name = 'input';

          // Create a text box to enter the name
          form.appendChild(document.createTextNode('Name: '));
          var placeName = form.appendChild(document.createElement('input'));
          placeName.type = 'text';
          placeName.id = 'text';
          placeName.name = 'tex';
          placeName.value = '';

          // Add a line break in the form
          form.appendChild(document.createElement("br"));

          // Create a text box to enter the description
          form.appendChild(document.createTextNode('Description: '));
          var placeDescription = form.appendChild(document.createElement('input'));
          placeDescription.type = 'text';
          placeDescription.id = 'text';
          placeDescription.name = 'tex';
          placeDescription.value = '';

          // Listen for a keyup
          form.addEventListener("keyup", function () {
            layer.feature.properties.name = placeName.value;
            layer.feature.properties.description = placeDescription.value;
          });
          layer.on("popupopen", function () {
            placeName.value = layer.feature.properties.name;
            placeDescription.value = layer.feature.properties.description;
            form.focus();
          });
          layer.bindPopup(form).openPopup();
        }

        function downloadObjectAsJson(exportObj, exportName){
          var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj));
          var downloadAnchorNode = document.createElement('a');
          downloadAnchorNode.setAttribute("href",     dataStr);
          downloadAnchorNode.setAttribute("download", exportName + ".geojson");
          downloadAnchorNode.click();
          downloadAnchorNode.remove();
        }

    </script>

</body>

</html>
